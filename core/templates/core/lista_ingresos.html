{% extends 'core/base.html' %}
{% load humanize %}

{% block content %}
<div class="container-fluid">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="text-dark fw-bold m-0">Reporte de Egresos</h3>
            <p class="text-muted small m-0">Gestión inteligente de gastos</p>
        </div>
        
        <div class="d-flex gap-2">
            <a href="{% url 'importar_excel' %}" class="btn btn-primary shadow-sm">
                <i class="bi bi-file-earmark-spreadsheet-fill me-2"></i>Importar Excel
            </a>
            <a href="{% url 'nuevo_ingreso' %}" class="btn btn-success text-white fw-bold shadow-sm">
                <i class="bi bi-plus-lg me-2"></i>Nuevo Gasto
            </a>
        </div>
    </div>

    <div class="row mb-4">
        
        <div class="col-xl-8 col-lg-7 mb-4 mb-lg-0">
            <div class="card shadow-sm border-0 h-100 bg-white">
                <div class="card-body p-3">
                    <form id="filtroForm" method="get">
                        <input type="hidden" name="page" id="page" value="1">

                        <h6 class="text-primary fw-bold mb-3 small text-uppercase border-bottom pb-2">
                            <i class="bi bi-funnel-fill me-1"></i> Filtros de Búsqueda
                        </h6>

                        <div class="input-group mb-3">
                            <span class="input-group-text bg-light border-0"><i class="bi bi-search"></i></span>
                            <input type="text" name="q" class="form-control border-0 bg-light" 
                                   placeholder="Escribe para buscar (Descripción, Empresa, Detalle)..." 
                                   value="{{ request.GET.q|default:'' }}"
                                   onkeyup="if(event.keyCode === 13) cambiarPagina(1);"> 
                            <button type="button" class="btn btn-primary fw-bold" onclick="cambiarPagina(1)">Buscar</button>
                        </div>

                        <button class="btn btn-sm btn-outline-secondary w-100" type="button" data-bs-toggle="collapse" data-bs-target="#submenuFiltros">
                            <i class="bi bi-sliders me-1"></i> Mostrar/Ocultar Filtros Avanzados
                        </button>

                        <div class="collapse {% if filtros_activos %}show{% endif %} mt-3" id="submenuFiltros">
                            <div class="bg-light p-3 rounded border">
                                <div class="row g-2">
                                    <div class="col-md-4">
                                        <label class="small fw-bold text-muted">Empresa</label>
                                        <select name="empresa" class="form-select form-select-sm" onchange="cambiarPagina(1)">
                                            <option value="">Todas</option>
                                            {% for item in empresas %}
                                                <option value="{{ item.id }}" {% if empresa_sel == item.id %}selected{% endif %}>{{ item.nombre }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="small fw-bold text-muted">Centro Costo</label>
                                        <select name="centro" class="form-select form-select-sm" onchange="cambiarPagina(1)">
                                            <option value="">Todos</option>
                                            {% for item in centros %}
                                                <option value="{{ item.id }}" {% if centro_sel == item.id %}selected{% endif %}>{{ item.nombre }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="small fw-bold text-muted">Clasificación</label>
                                        <select name="clasificacion" class="form-select form-select-sm" onchange="cambiarPagina(1)">
                                            <option value="">Todas</option>
                                            {% for item in clasificaciones %}
                                                <option value="{{ item.id }}" {% if clasif_sel == item.id %}selected{% endif %}>{{ item.nombre }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <label class="small fw-bold text-muted">Ordenar</label>
                                        <select name="orden" class="form-select form-select-sm" onchange="cambiarPagina(1)">
                                            <option value="fecha_desc" {% if orden_sel == 'fecha_desc' %}selected{% endif %}>Recientes</option>
                                            <option value="fecha_asc" {% if orden_sel == 'fecha_asc' %}selected{% endif %}>Antiguos</option>
                                            <option value="monto_desc" {% if orden_sel == 'monto_desc' %}selected{% endif %}>Mayor Monto</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="small fw-bold text-muted">Desde</label>
                                        <input type="date" name="fecha_inicio" class="form-control form-control-sm" value="{{ inicio_sel|default:'' }}" onchange="cambiarPagina(1)">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="small fw-bold text-muted">Hasta</label>
                                        <input type="date" name="fecha_fin" class="form-control form-control-sm" value="{{ fin_sel|default:'' }}" onchange="cambiarPagina(1)">
                                    </div>

                                    <div class="col-12 text-end mt-2">
                                        <a href="{% url 'lista_ingresos' %}" class="text-danger small text-decoration-none">
                                            <i class="bi bi-x-circle"></i> Limpiar Filtros
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-xl-4 col-lg-5">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-body p-3 d-flex flex-column">
                    <div class="d-flex justify-content-between align-items-center mb-2 border-bottom pb-2">
                        <h6 class="text-primary fw-bold small text-uppercase m-0">
                            <i class="bi bi-graph-up me-1"></i> Tendencia
                        </h6>
                        <span class="badge bg-success bg-opacity-10 text-success" style="font-size: 0.7rem;">Dinámico</span>
                    </div>
                    
                    <div class="flex-grow-1" style="min-height: 180px; position: relative;">
                        <canvas id="graficoIngresos"></canvas>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div class="card shadow border-0" style="border-radius: 12px; overflow: hidden;">
        <div class="card-body p-0">
            <div class="table-responsive" id="tabla-container" style="min-height: 200px;">
                <div id="tabla-body">
                    {% include 'core/partials/tabla_ingresos.html' %}
                </div>
            </div>
        </div>
        
        <div class="card-footer bg-white border-top p-3" id="paginacion-container">
            {% include 'core/partials/paginacion.html' %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    let myChart = null;

    // --- CARGA INICIAL ---
    $(document).ready(function() {
        const labels = {{ labels_grafico|safe|default:"[]" }};
        const data = {{ data_grafico|safe|default:"[]" }};
        initChart(labels, data);
    });

    // --- FUNCIÓN DIBUJAR GRÁFICO ---
    function initChart(labels, dataValues) {
        const ctx = document.getElementById('graficoIngresos');
        if (!ctx) return; 

        if (myChart) {
            myChart.destroy();
        }

        myChart = new Chart(ctx.getContext('2d'), {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Monto',
                    data: dataValues,
                    borderColor: '#4e73df',
                    backgroundColor: 'rgba(78, 115, 223, 0.05)',
                    borderWidth: 2,
                    pointRadius: 3,
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false, // Importante para que se ajuste a la caja derecha
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP' }).format(context.parsed.y);
                            }
                        }
                    }
                },
                scales: {
                    x: { grid: { display: false }, ticks: { maxTicksLimit: 6 } }, // Menos etiquetas en X para que quepan
                    y: { 
                        beginAtZero: true,
                        grid: { borderDash: [2, 4], color: "#eaecf4" },
                        ticks: {
                            callback: function(value) { return '$' + value.toLocaleString('es-CL'); }
                        }
                    }
                }
            }
        });
    }

    // --- FUNCIÓN AJAX ---
    function cambiarPagina(numeroPagina) {
        $('#page').val(numeroPagina);
        
        $('#tabla-container').css('opacity', '0.5');
        $('canvas').css('opacity', '0.5');

        var formData = $('#filtroForm').serialize() + '&modo_ajax=true';

        $.ajax({
            url: "{% url 'lista_ingresos' %}",
            data: formData,
            success: function(response) {
                $('#tabla-body').html(response.html_tabla);
                $('#paginacion-container').html(response.html_paginacion);
                initChart(response.grafico_labels, response.grafico_data);
                
                $('#tabla-container').css('opacity', '1');
                $('canvas').css('opacity', '1');
            },
            error: function() {
                alert('Error de conexión.');
                $('#tabla-container').css('opacity', '1');
            }
        });
    }
</script>
{% endblock %}