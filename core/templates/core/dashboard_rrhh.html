{% extends 'core/base.html' %}
{% load humanize %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

<div class="container-fluid">

    <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-4 gap-3">
        <div>
            <h3 class="fw-bold text-dark m-0">Recursos Humanos</h3>
            <p class="text-muted small m-0">
                Viendo: <span class="fw-bold text-primary" id="tituloPagina">{{ nombre_empresa|default:"Todas las Empresas" }}</span>
            </p>
        </div>
        
        <div class="d-flex gap-2 flex-wrap justify-content-center">
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-info" id="btn-Samka" onclick="cargarEmpresa('Samka')">
                    Samka
                </button>
                <button type="button" class="btn btn-outline-success" id="btn-Maquehue" onclick="cargarEmpresa('Maquehue')">
                    Maquehue
                </button>
                <button type="button" class="btn btn-outline-secondary active" id="btn-Todas" onclick="cargarEmpresa('')">
                    Ver Todo
                </button>
            </div>

            <a href="{% url 'nuevo_trabajador' %}" class="btn btn-success">
                <i class="bi bi-person-plus-fill me-2"></i>Añadir Trabajador
            </a>

            <a href="{% url 'importar_rrhh' %}" class="btn btn-primary">
                <i class="bi bi-file-earmark-spreadsheet-fill me-2"></i>Importar Excel
            </a>
        </div>
    </div>

    <div class="row g-3 mb-4">
        
        <div class="col-md-5">
            <div class="card shadow-sm border-0 border-start border-4 border-info h-100">
                <div class="card-header bg-white py-2 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 fw-bold text-info text-uppercase small">
                        <i class="bi bi-table me-1"></i>Resumen de Dotación
                    </h6>
                    <span class="badge bg-info text-white">Actualizado</span>
                </div>
                <div class="card-body p-0">
                    <table class="table table-sm table-bordered mb-0 text-center align-middle" style="font-size: 0.9rem;">
                        <thead class="table-light text-secondary text-uppercase small">
                            <tr>
                                <th class="text-start ps-3 py-2">Empresa</th>
                                <th class="text-success py-2">Activos</th>
                                <th class="text-secondary py-2">Finiquitados</th>
                                <th class="py-2">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="text-start ps-3 fw-bold">Samka SPA</td>
                                <td class="fw-bold text-success bg-success bg-opacity-10">{{ samka_activos|default:"0" }}</td>
                                <td class="text-muted">{{ samka_finiquitados|default:"0" }}</td>
                                <td class="fw-bold">{{ samka_activos|add:samka_finiquitados }}</td>
                            </tr>
                            <tr>
                                <td class="text-start ps-3 fw-bold">Maquehue SPA</td>
                                <td class="fw-bold text-success bg-success bg-opacity-10">{{ maquehue_activos|default:"0" }}</td>
                                <td class="text-muted">{{ maquehue_finiquitados|default:"0" }}</td>
                                <td class="fw-bold">{{ maquehue_activos|add:maquehue_finiquitados }}</td>
                            </tr>
                            <tr class="table-secondary fw-bold" style="border-top: 2px solid #d1d3e2;">
                                <td class="text-start ps-3">TOTAL GENERAL</td>
                                <td class="text-success">{{ total_activos|default:"0" }}</td>
                                <td class="text-secondary">{{ total_finiquitados|default:"0" }}</td>
                                <td>{{ total_activos|add:total_finiquitados }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-md-7">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-white py-2 border-bottom-0">
                    <h6 class="m-0 fw-bold text-danger small text-uppercase">
                        <i class="bi bi-graph-up me-1"></i>Evolución Costo Finiquitos
                    </h6>
                </div>
                <div class="card-body pt-0">
                    <div style="height: 200px; width: 100%;">
                        <canvas id="graficoFiniquitos"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm border-0 mb-5">
        <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
            <h6 class="m-0 fw-bold text-dark">Detalle de Trabajadores</h6>
            <div class="small">
                <span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25 me-1">Activo</span>
                <span class="badge bg-secondary bg-opacity-10 text-secondary border border-secondary border-opacity-25">Finiquitado</span>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover align-middle" id="dataTable" width="100%">
                    <thead class="table-light">
                        <tr>
                            <th>Colaborador</th>
                            <th>RUT</th>
                            <th>Cargo</th>
                            <th>F. Contrato</th>
                            <th class="text-center">Estado</th>
                            <th class="text-end">Finiquito</th>
                            <th class="text-end">Tiempo</th>
                            <th class="text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-body">
                        {% include 'core/partials/tabla_trabajadores.html' %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_scripts %}
<link href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> 
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    let myChart = null;
    let table = null;

    $(document).ready(function() {
        // 1. Iniciar Tabla (Sin AJAX inicial)
        table = $('#dataTable').DataTable({
            "language": { "url": "//cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json" },
            "pageLength": 10,
            "order": [[ 0, "asc" ]]
        });

        // 2. Iniciar Gráfico
        const labelsData = {{ labels_grafico|safe|default:"[]" }};
        const valuesData = {{ data_grafico|safe|default:"[]" }};

        initChart({
            labels: labelsData,
            datasets: [{
                label: 'Monto Finiquitos',
                data: valuesData,
                borderColor: '#dc3545',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                borderWidth: 2,
                pointRadius: 3,
                pointHoverRadius: 6,
                pointBackgroundColor: '#dc3545',
                fill: true,
                tension: 0.3
            }]
        });
    });

    // 3. Función Constructora del Gráfico
    function initChart(dataConfig) {
        if (myChart) myChart.destroy();
        
        const ctx = document.getElementById('graficoFiniquitos').getContext('2d');

        myChart = new Chart(ctx, {
            type: 'line',
            data: dataConfig,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: { 
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(255, 255, 255, 0.95)',
                        titleColor: '#6e707e',
                        bodyColor: '#dc3545',
                        borderColor: '#e3e6f0',
                        borderWidth: 1,
                        padding: 10,
                        displayColors: false,
                        callbacks: {
                            label: function(context) {
                                return new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP' }).format(context.parsed.y);
                            }
                        }
                    }
                },
                scales: {
                    x: { grid: { display: false }, ticks: { font: { size: 10 } } },
                    y: { 
                        beginAtZero: true, 
                        grid: { borderDash: [2, 4], color: "#eaecf4" },
                        ticks: { 
                            font: { size: 10 },
                            callback: function(val) { return '$' + val.toLocaleString('es-CL'); } 
                        } 
                    }
                }
            }
        });
    }

    // 4. Función AJAX (Cuando cambias de Empresa)
    function cargarEmpresa(empresa) {
        $('#tabla-body').css('opacity', '0.5');

        $.ajax({
            url: "{% url 'dashboard_rrhh' %}",
            data: { 
                'empresa': empresa,
                'modo_ajax': 'true'
            },
            success: function(response) {
                // Actualizar Título
                $('#tituloPagina').text(response.titulo_pagina);
                
                // Actualizar Botones Activos
                $('.btn-group .btn').removeClass('active');
                if (empresa === 'Samka') $('#btn-Samka').addClass('active');
                else if (empresa === 'Maquehue') $('#btn-Maquehue').addClass('active');
                else $('#btn-Todas').addClass('active');

                // Actualizar Tabla
                if (table) table.destroy();
                $('#tabla-body').html(response.html_tabla);
                $('#tabla-body').css('opacity', '1');
                
                table = $('#dataTable').DataTable({
                    "language": { "url": "//cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json" },
                    "pageLength": 10,
                    "order": [[ 0, "asc" ]]
                });

                // Actualizar Gráfico
                initChart({
                    labels: response.labels_grafico,
                    datasets: [{
                        label: 'Monto Finiquitos',
                        data: response.data_grafico,
                        borderColor: '#dc3545',
                        backgroundColor: 'rgba(220, 53, 69, 0.1)',
                        borderWidth: 2,
                        pointRadius: 3,
                        pointHoverRadius: 6,
                        pointBackgroundColor: '#dc3545',
                        fill: true,
                        tension: 0.3
                    }]
                });
            },
            error: function(xhr, status, error) {
                console.error("Error:", error);
                // Usamos SweetAlert si está disponible, si no alert normal
                if (typeof Swal !== 'undefined') {
                    Swal.fire('Error', 'No se pudieron cargar los datos', 'error');
                } else {
                    alert("Error al cargar datos.");
                }
                $('#tabla-body').css('opacity', '1');
            }
        });
    }
</script>
{% endblock %}